!function(e){"use strict";window.jiZhuReaderBackground={init:function(){var e=this;e.initConnect(),e.browserAction(),e.createContextMenu()},initConnect:function(){var e=this;chrome.extension.onConnect.addListener(function(t){switch(t.name){case"createreader":e.createReader();break;case"articlefrompage":e.articlefrompageHandler(t);break;case"appendcontent":e.appendContentHandler(t);break;case"lookup-phrase":e.lookupPhraseHandler(t);break;case"check-words":e.checkWordsHandler(t);break;case"getsettings":e.getSettingsHandler(t)}})},articlefrompageHandler:function(e){var t=this;e.onMessage.addListener(function(n){chrome.tabs.sendRequest(e.sender.tab.id,{name:"sendarticletoreader",data:n,settings:t.getSettings()})})},appendContentHandler:function(e){e.onMessage.addListener(function(t){chrome.tabs.sendRequest(e.sender.tab.id,{name:"superaddtoreader",data:t})})},lookupPhraseHandler:function(e){var t=this;e.onMessage.addListener(function(n){var a=function(t){chrome.tabs.sendRequest(e.sender.tab.id,{name:"lookupphrase-result",data:{dictData:t,position:n.position,from:n.from,phrase:n.phrase}})};t.lookupPhrase(n.phrase,a)})},checkWordsHandler:function(e){var t=this;e.onMessage.addListener(function(n){var a=n.words,r=a.length,o=[],i=function(n){o.push(n),o.length===r?chrome.tabs.sendRequest(e.sender.tab.id,{name:"checkwords-result",data:{dictDataArr:o}}):t.lookupPhrase(a.shift(),i)};t.lookupPhrase(a.shift(),i)})},lookupPhrase:function(t,n){var a,r=this,o="DICT-DATA",i=function(i){e.ajax({url:"http://dict.youdao.com/fsearch?q="+encodeURIComponent(t),success:function(c){var s=r.getDictData(e(c));s.phrase=t,i||(i={},i[o]={}),i[o][t]={dictData:s,createTime:Date.now()},StorageArea.set(i),a||n(s)}})};StorageArea.get(o,function(e){e[o]?e[o][t]?(a=Date.now()-e[o][t].createTime>2592e6,n(e[o][t].dictData),a&&i(e)):i(e):i()})},getSettingsHandler:function(e){var t=this;e.onMessage.addListener(function(n){chrome.tabs.sendRequest(e.sender.tab.id,{name:"settings",data:t.getSettings()})})},browserAction:function(){var e=this;chrome.browserAction.onClicked.addListener(function(t){e.createReader()})},createContextMenu:function(){var e=this;chrome.contextMenus.create({contexts:["page","frame","link","editable","image","video","audio","browser_action","page_action"],title:chrome.i18n.getMessage("ContextMenuReader"),onclick:function(t,n){e.createReader()}}),chrome.contextMenus.create({contexts:["page","link","editable"],title:chrome.i18n.getMessage("ContextMenuCheckAllPageWords"),onclick:function(t,n){e.createWordsChecker()}}),chrome.contextMenus.create({contexts:["selection"],title:chrome.i18n.getMessage("TranslateWord"),onclick:function(t,n){var a=t.selectionText,r=function(e){var t={dictData:e,position:{top:0,left:0,right:0},from:"page",phrase:a};chrome.tabs.executeScript(null,{code:"App.modules.dictLayer.init("+JSON.stringify(t)+")"})};e.lookupPhrase(a,r)}})},createReader:function(){chrome.tabs.executeScript(null,{code:"jiZhuReader.create()"})},createWordsChecker:function(){chrome.tabs.executeScript(null,{code:"jzWordsChecker.create()"})},getSettings:function(){var e=window.jiZhuReaderOptions;return{dictHostpage:e.dictHostpage,dictJzpage:e.dictJzpage}},getDictData:function(t){var n=[],a=t.find("custom-translation content");e.each(a,function(t,a){n.push(e(a).text())});var r=[],o=t.find("web-translation");e.each(o,function(t,n){r.push({key:e(n).find("key").text(),value:function(){var t=[];return e.each(e(n).find("trans value"),function(){t.push(e(this).text())}),t.join(", ")}()})});var i={phrase:t.find("return-phrase").text(),phoneticSymbol:t.find("phonetic-symbol").text(),translation:n,hasMore:r.length>0,moreTranslatioin:r};return i}},e(function(){jiZhuReaderBackground.init()})}(Zepto);