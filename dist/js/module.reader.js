!function(t){"use strict";App.modules.reader={__settings:{},init:function(){var e=this;e.currentPageNum=1,e.jzContentWrap=t("#jz-contentwrap"),e.jzArticle=t("#jz-article"),e.jzTitle=t("#jz-title"),e.jzSubtitle=t("#jz-subtitle"),e.notifyParent(),e.getPageContent(),e.initExtensionRequest(),e.initActionBtn()},getPageContent:function(){parent.postMessage({name:"getpagecontent"},"*")},notifyParent:function(){parent.postMessage({name:"afterinitreader"},"*")},initExtensionRequest:function(){var t=this;chrome.extension.onRequest.addListener(function(e,n,i){if(n&&n.id===chrome.i18n.getMessage("@@extension_id"))switch(e.name){case"sendarticletoreader":t.sendarticletoreaderHandler(e.data,e.settings);break;case"superaddtoreader":t.superaddtoreaderHandler(e.data);break;case"lookupphrase-result":if("reader"!==e.data.from)return;t.lookupPhraseResultHandler(e.data)}})},sendarticletoreaderHandler:function(e,n){var i=this;if(""!==e.content){var a=t("<section>",{"class":"jz-addcontent",html:e.content});i.jzArticle.find(".jz-loading-tip").remove(),i.jzArticle.append(a).find("pre, code, xmp").addClass("prettyprint"),prettyPrint()}var o=e.title.trim();""!==o&&(i.jzTitle.html(o),document.title=o,/.*[\u4e00-\u9fa5]+.*$/.test(o)&&t(document.body).addClass("chinese-article")),""!==e.subtitle&&i.jzSubtitle.html(e.subtitle),t.jps.publish("init-selectionphrase",{container:t("#jz-contentwrap"),dictLookup:n.dictJzpage||"selection",from:"reader"}),i.__settings=n},superaddtoreaderHandler:function(e){var n=this;if(""!==e.content){n.currentPageNum++;var i=t("<section>",{"class":"jz-addcontent"}),a=t("<div>",{"class":"jz-pagecontent",html:e.content}),o=t("<h6>",{text:chrome.i18n.getMessage("Pagination",[n.currentPageNum]),"class":"jz-pagenum"});i.append(o).append(a),n.jzArticle.append(i).find("pre, code, xmp").addClass("prettyprint"),prettyPrint(i[0])}},initActionBtn:function(){var e=this;t("#jz-closebtn").click(function(){parent.postMessage({name:"removeiframe"},"*")}).attr("title",chrome.i18n.getMessage("Goback")),t("#jz-editbtn").click(function(){e.editContent()}).attr("title",chrome.i18n.getMessage("Edit")),t("#jz-printbtn").click(function(){t("#jz-sider").removeClass("hover"),window.print()}).attr("title",chrome.i18n.getMessage("Print")),t("#jz-helpbtn").click(function(){return e.showHelpTip(),!1}).attr("title",chrome.i18n.getMessage("Help")),t("#jz-sider").mouseenter(function(){t(this).addClass("hover")}).mouseleave(function(){t(this).removeClass("hover")}),t(document).keydown(function(t){27===t.which&&parent.postMessage({name:"removeiframe"},"*")})},editContent:function(){var e=this;"true"===e.jzContentWrap.attr("contenteditable")?(e.jzContentWrap.attr("contenteditable","false").blur(),t("#jz-editbtn").attr("title",chrome.i18n.getMessage("Edit"))):(e.jzContentWrap.attr("contenteditable","true").focus(),t("#jz-editbtn").attr("title",chrome.i18n.getMessage("Save")))},showHelpTip:function(){var t=this;t.showModal(chrome.i18n.getMessage("HelpModalTip"))},showModal:function(e,n){var i=this,a=t("<div>",{"class":"jz-modal-backdrop"}).appendTo(document.body),o='<div class="jz-modal jz-help-modal">   <div class="jz-modal-hd">       <button type="button" class="close">Ã—</button>       <h3></h3>   </div>   <div class="jz-modal-bd"></div></div>',r=t(o);r.find("h3").append(n||chrome.i18n.getMessage("ExtensionName")),r.find(".jz-modal-bd").append(e),r.appendTo(document.body);var s=function(){t(document.body).off("click.closemodal"),r.css("opacity",0),setTimeout(function(){r.remove(),a.remove(),i.modal=null},300)};t(document.body).on("click.closemodal",function(t){return 0===r.has(t.target).length?(s(),!1):!0}),r.find(".close").click(function(t){return s(),!1}),i.modal=r},lookupPhraseResultHandler:function(e){var n=this;t.jps.publish("init-dict-layer",{dictData:e.dictData,position:e.position,hover:"hover"===n.__settings.dictJzpage})}}}(Zepto);